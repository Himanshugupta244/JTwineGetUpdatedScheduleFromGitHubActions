name: Update JTwine Schedule

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *"  # every 5 minutes

jobs:
  update-schedule:
    runs-on: ubuntu-latest

    steps:
    # 1️⃣ Checkout the repository
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # 2️⃣ Setup Java JDK 17
    - name: Setup JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: 17

    # 3️⃣ Setup Chrome for Selenium
    - name: Setup Chrome
      uses: browser-actions/setup-chrome@v1

    # 4️⃣ Build Project with Maven
    - name: Build Project
      run: mvn clean compile

    # 5️⃣ Run Selenium Program
    - name: Run Selenium Program
      env:
        JTWINE_USERNAME_HIM: ${{ secrets.JTWINE_USERNAME_HIM }}
        JTWINE_PASSWORD_HIM: ${{ secrets.JTWINE_PASSWORD_HIM }}
        JTWINE_USERNAME_SUD: ${{ secrets.JTWINE_USERNAME_SUD }}
        JTWINE_PASSWORD_SUD: ${{ secrets.JTWINE_PASSWORD_SUD }}
        VPROP_USERNAME_HIM: ${{ secrets.VPROP_USERNAME_HIM }}
        VPROP_PASSWORD_HIM: ${{ secrets.VPROP_PASSWORD_HIM }}
      run: mvn exec:java -Dexec.mainClass="GmailProjectForGitHubActions.JTwineScheduleForTodayFromGitHubActions"

    # 6️⃣ Move schedule.txt to deploy folder and commit
    - name: Move and Commit schedule.txt
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        
        # create deploy folder if it doesn't exist
        mkdir -p deploy
        
        # move schedule.txt only if it exists in root
        if [ -f schedule.txt ]; then
            mv schedule.txt deploy/schedule.txt
        fi

        # add changes to git
        git add deploy/schedule.txt

        # commit and push
        git commit -m "Update schedule.txt [ci skip]" || echo "No changes"
        git push --force-with-lease

    # 7️⃣ Upload to Hostinger via FTP
    - name: Upload schedule.txt via FTP to Hostinger
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./deploy/
        server-dir: ./
